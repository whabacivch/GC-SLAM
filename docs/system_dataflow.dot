digraph G {
    rankdir=TB;
    bgcolor="#0a0a0a";
    fontcolor="#ffffff";
    fontsize=12;
    node [fontname="Arial", fontsize=9, shape=box, style="filled,rounded"];
    edge [color="#666666", penwidth=1.2];
    splines=polyline;
    nodesep=0.4;
    ranksep=0.8;
    compound=true;

    // ============================================================================
    // COLOR SCHEME
    // ============================================================================
    // Active/Processing: Green shades
    // State/Storage: Dark gray
    // Evidence: Cyan/Blue
    // Approximate ops: Orange border
    // Closed-form ops: Green border
    // Dead-end: Red
    // Output: Blue

    // ============================================================================
    // LAYER 1: ROSBAG INPUTS (Centered at Top)
    // ============================================================================
    subgraph cluster_rosbag {
        label="ðŸ“¦ Rosbag Source (M3DGR Dynamic01)";
        style="filled,rounded";
        fillcolor="#1a1a1a";
        color="#555555";
        fontcolor="#cccccc";
        fontsize=11;

        // All 9 topics from rosbag
        BAG_VRPN [label="/vrpn_client_node/UGV/pose\n(Ground Truth)", 
                  fillcolor="#2a0e0e", style="filled,rounded,dashed", 
                  color="#ff4444", fontcolor="#ffcccc"];
        BAG_CAM_IMU [label="/camera/imu", 
                     fillcolor="#2a0e0e", style="filled,rounded,dashed", 
                     color="#ff4444", fontcolor="#ffcccc"];
        BAG_CAM_COLOR [label="/camera/color/image_raw/compressed", 
                       fillcolor="#2a0e0e", style="filled,rounded,dashed", 
                       color="#ff4444", fontcolor="#ffcccc"];
        BAG_CAM_DEPTH [label="/camera/aligned_depth_to_color/image_raw/compressedDepth", 
                       fillcolor="#2a0e0e", style="filled,rounded,dashed", 
                       color="#ff4444", fontcolor="#ffcccc"];
        BAG_AVIA_LIDAR [label="/livox/avia/lidar", 
                        fillcolor="#2a0e0e", style="filled,rounded,dashed", 
                        color="#ff4444", fontcolor="#ffcccc"];
        BAG_AVIA_IMU [label="/livox/avia/imu", 
                      fillcolor="#2a0e0e", style="filled,rounded,dashed", 
                      color="#ff4444", fontcolor="#ffcccc"];
        BAG_ODOM [label="/odom\nOdometry\n(20 Hz)", 
                 fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];
        BAG_MID_LIDAR [label="/livox/mid360/lidar\nCustomMsg\n(10 Hz)", 
                       fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];
        BAG_MID_IMU [label="/livox/mid360/imu\nImu\n(200 Hz)", 
                     fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];

        // Force all 9 nodes to be on same rank and centered within cluster
        { rank=same; BAG_VRPN; BAG_CAM_IMU; BAG_CAM_COLOR; BAG_CAM_DEPTH; BAG_AVIA_LIDAR; BAG_AVIA_IMU; BAG_ODOM; BAG_MID_LIDAR; BAG_MID_IMU; }
        BAG_VRPN -> BAG_CAM_IMU -> BAG_CAM_COLOR -> BAG_CAM_DEPTH -> BAG_AVIA_LIDAR -> BAG_AVIA_IMU -> BAG_ODOM -> BAG_MID_LIDAR -> BAG_MID_IMU [style="invis"];
        
        // Ensure cluster is at top rank
        { rank=source; BAG_VRPN; BAG_CAM_IMU; BAG_CAM_COLOR; BAG_CAM_DEPTH; BAG_AVIA_LIDAR; BAG_AVIA_IMU; BAG_ODOM; BAG_MID_LIDAR; BAG_MID_IMU; }
    }

    // ============================================================================
    // LAYER 2: SENSOR HUB
    // ============================================================================
    subgraph cluster_hub {
        label="ðŸ”§ gc_sensor_hub (Single Process)";
        style="filled,rounded";
        fillcolor="#1a1a1a";
        color="#555555";
        fontcolor="#cccccc";
        fontsize=11;
        nodesep=1.5;  // Triple the spacing for wider layer

        LIVOX_CONV [label="livox_converter\nCustomMsg â†’ PointCloud2", 
                    fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];
        ODOM_NORM [label="odom_normalizer\nFrame: odom_combined â†’ base_footprint", 
                   fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];
        IMU_NORM [label="imu_normalizer\nFrame: livox_frame", 
                  fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];
        DEAD_AUDIT [label="dead_end_audit\nTracks unused topics", 
                    fillcolor="#2d004d", color="#aa00aa", fontcolor="#ffffff"];

        { rank=same; ODOM_NORM; LIVOX_CONV; IMU_NORM; DEAD_AUDIT; }
        // Force wide spacing between all nodes
        ODOM_NORM -> LIVOX_CONV [style="invis", minlen=4];
        LIVOX_CONV -> IMU_NORM [style="invis", minlen=4];
        IMU_NORM -> DEAD_AUDIT [style="invis", minlen=4];
    }

    // ============================================================================
    // LAYER 2.5: CANONICAL TOPICS
    // ============================================================================
    subgraph cluster_canon {
        label="ðŸ“¡ Canonical Topics (/gc/sensors/*)";
        style="filled,rounded";
        fillcolor="#0f2a0f";
        color="#33aa33";
        fontcolor="#cccccc";
        fontsize=11;

        CAN_ODOM [label="/gc/sensors/odom\nnav_msgs/Odometry", 
                  fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];
        CAN_LIDAR [label="/gc/sensors/lidar_points\nsensor_msgs/PointCloud2", 
                   fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];
        CAN_IMU [label="/gc/sensors/imu\nsensor_msgs/Imu", 
                 fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff"];
        CAN_DEAD [label="/gc/dead_end_status\nJSON", 
                  fillcolor="#2d004d", color="#aa00aa", fontcolor="#ffffff"];

        { rank=same; CAN_ODOM; CAN_LIDAR; CAN_IMU; CAN_DEAD; }
        CAN_ODOM -> CAN_LIDAR -> CAN_IMU -> CAN_DEAD [style="invis"];
    }

    // ============================================================================
    // LAYER 3: BACKEND - STATE STORAGE
    // ============================================================================
    subgraph cluster_state {
        label="ðŸ’¾ State Storage";
        style="filled,rounded";
        fillcolor="#0a0a1a";
        color="#444466";
        fontcolor="#cccccc";
        fontsize=11;

        ST_BELIEF [label="BeliefGaussianInfo\n22D Ã— 4 Hypotheses\n(Info form: L, h)", 
                   fillcolor="#1e1e2e", color="#6666aa", fontcolor="#ffffff"];
        ST_MAP [label="MapBinStats\n48 Bins\n(S_dir, N_dir, Î¼_dir, Îº)", 
                 fillcolor="#1e1e2e", color="#6666aa", fontcolor="#ffffff"];
        ST_PROC [label="ProcessNoiseIW\nQ (22Ã—22)\n(trans, rot, vel, biases, dt, ex)", 
                 fillcolor="#1e1e2e", color="#6666aa", fontcolor="#aaaaaa"];
        ST_MEAS [label="MeasNoiseIW\nÎ£g, Î£a, Î£lidar\n(Per-sensor IW)", 
                  fillcolor="#1e1e2e", color="#6666aa", fontcolor="#aaaaaa"];
        ST_BUCKET [label="BucketNoiseIW\nPer-bin Î»\n(LiDAR reliability)", 
                   fillcolor="#1e1e2e", color="#6666aa", fontcolor="#aaaaaa"];

        { rank=same; ST_BELIEF; ST_MAP; ST_PROC; ST_MEAS; ST_BUCKET; }
        ST_BELIEF -> ST_MAP -> ST_PROC -> ST_MEAS -> ST_BUCKET [style="invis"];
    }

    // ============================================================================
    // LAYER 4: BACKEND - IMU BUFFER
    // ============================================================================
    subgraph cluster_imu_buf {
        label="ðŸ“¥ IMU Buffer";
        style="filled,rounded";
        fillcolor="#0a1a0a";
        color="#336633";
        fontcolor="#cccccc";
        fontsize=11;

        IMU_BUF [label="IMU Buffer\n(stamp, gyro, accel)\nMax: 4000 msgs\nUsed for: Deskew + Evidence", 
                 fillcolor="#1e3e1e", color="#66aa66", fontcolor="#ffffff"];
    }

    // ============================================================================
    // LAYER 5: BACKEND - PIPELINE (Per-Hypothesis)
    // ============================================================================
    subgraph cluster_pipeline {
        label="ðŸ§  gc_backend_node - Pipeline (15 Steps Ã— 4 Hypotheses)";
        style="filled,rounded";
        fillcolor="#1a1a2a";
        color="#666666";
        fontcolor="#cccccc";
        fontsize=11;

        // ====== GROUP 1: PREPROCESSING (S01-S03) ======
        subgraph cluster_preproc {
            label="Preprocessing";
            style="filled,rounded";
            fillcolor="#1a2a1a";
            color="#44aa44";
            fontcolor="#cccccc";
            fontsize=10;

            S01 [label="S01: PointBudgetResample\nMax: 8192 points\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];
            S02 [label="S02: PredictDiffusion\nUses: Q, dt, belief_prev\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];
            S03 [label="S03: DeskewConstantTwist\nUses: IMU preintegration\n(Approximate)", 
                 fillcolor="#4a3a1a", color="#ff8800", fontcolor="#ffffff"];

            S01 -> S02 -> S03 [color="#00ff00", penwidth=2];
        }

        // ====== GROUP 2: BINNING & ORIENTATION (S04-S08) ======
        subgraph cluster_binning {
            label="Binning & Pose Estimation";
            style="filled,rounded";
            fillcolor="#1a2a1a";
            color="#44aa44";
            fontcolor="#cccccc";
            fontsize=10;

            S04 [label="S04: BinSoftAssign\nÏ„=0.1, 48 bins\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];
            S05 [label="S05: ScanBinMomentMatch\nUses: map_stats, bucket_noise\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];
            S06 [label="S06: KappaFromResultant\nÎº_map, Îº_scan\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];
            S07 [label="S07: WahbaSVD\nRotation RÌ‚\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];
            S08 [label="S08: TranslationWLS\nTranslation tÌ‚\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];

            S04 -> S05 -> S06 -> S07 -> S08 [color="#00ff00", penwidth=2];
        }

        // ====== GROUP 3: EVIDENCE (S09 - Parallel) ======
        subgraph cluster_evidence {
            label="Evidence Generation (Parallel)";
            style="filled,rounded";
            fillcolor="#1a2a3a";
            color="#4488aa";
            fontcolor="#cccccc";
            fontsize=10;

            S09A [label="S09a: OdomQuadraticEvidence\nGaussian SE(3) pose\n(Closed-form)", 
                  fillcolor="#2a4a6a", color="#00ccff", fontcolor="#ffffff"];
            S09B [label="S09b: ImuVMFGravityEvidence\nvMF on SÂ²\n(Laplace approx)", 
                  fillcolor="#4a3a1a", color="#ff8800", fontcolor="#ffffff"];
            S09C [label="S09c: ImuGyroRotationEvidence\nGaussian SO(3)\n(Closed-form)", 
                  fillcolor="#2a4a6a", color="#00ccff", fontcolor="#ffffff"];
            S09D [label="S09d: LidarQuadraticEvidence\nPose information\n(Closed-form)", 
                  fillcolor="#2a4a6a", color="#00ccff", fontcolor="#ffffff"];

            { rank=same; S09A; S09B; S09C; S09D; }
            S09A -> S09B -> S09C -> S09D [style="invis"];
        }

        // ====== GROUP 4: FUSION & UPDATE (S10-S14) ======
        subgraph cluster_fusion {
            label="Fusion & State Update";
            style="filled,rounded";
            fillcolor="#1a2a1a";
            color="#44aa44";
            fontcolor="#cccccc";
            fontsize=10;

            S10 [label="S10: FusionScaleFromCertificates\nExcitation scaling\n(Approximate)", 
                 fillcolor="#4a3a1a", color="#ff8800", fontcolor="#ffffff"];
            S11 [label="S11: InfoFusionAdditive\nL = L_prior + L_evidence\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];
            S12 [label="S12: PoseUpdateFrobeniusRecompose\nFrobenius correction\n(Approximate)", 
                 fillcolor="#4a3a1a", color="#ff8800", fontcolor="#ffffff"];
            S13 [label="S13: PoseCovInflationPushforward\nMap update\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];
            S14 [label="S14: AnchorDriftUpdate\nAnchor maintenance\n(Closed-form)", 
                 fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff"];

            S10 -> S11 -> S12 -> S13 -> S14 [color="#00ff00", penwidth=2];
        }

        // Pipeline flow between groups
        S03 -> S04 [color="#00ff00", penwidth=2];
        S08 -> S09A [color="#00ccff", penwidth=2];
        S08 -> S09B [color="#00ccff", penwidth=2];
        S08 -> S09C [color="#00ccff", penwidth=2];
        S08 -> S09D [color="#00ccff", penwidth=2];
        S09A -> S10 [color="#00ccff", penwidth=2];
        S09B -> S10 [color="#00ccff", penwidth=2];
        S09C -> S10 [color="#00ccff", penwidth=2];
        S09D -> S10 [color="#00ccff", penwidth=2];
    }

    // ============================================================================
    // LAYER 6: HYPOTHESIS MERGE
    // ============================================================================
    subgraph cluster_hypo {
        label="ðŸ”„ Hypothesis Barycenter";
        style="filled,rounded";
        fillcolor="#2a1a1a";
        color="#aa4444";
        fontcolor="#cccccc";
        fontsize=11;

        S15 [label="S15: HypothesisBarycenter\n4 Hypotheses â†’ 1 Belief\n(Closed-form)", 
              fillcolor="#4a2a2a", color="#ff6666", fontcolor="#ffffff"];
    }

    // ============================================================================
    // LAYER 7: OUTPUTS
    // ============================================================================
    subgraph cluster_out {
        label="ðŸ“¤ Outputs";
        style="filled,rounded";
        fillcolor="#0a1a2a";
        color="#444466";
        fontcolor="#cccccc";
        fontsize=11;

        OUT_STATE [label="/gc/state\nnav_msgs/Odometry\n(6Ã—6 covariance)", 
                   fillcolor="#003366", color="#4488ff", fontcolor="#ffffff"];
        OUT_TRAJ [label="/gc/trajectory\nnav_msgs/Path", 
                  fillcolor="#003366", color="#4488ff", fontcolor="#ffffff"];
        OUT_STATUS [label="/gc/status\nJSON\n(odom/scan/imu counts)", 
                    fillcolor="#003366", color="#4488ff", fontcolor="#ffffff"];
        OUT_MANIFEST [label="/gc/runtime_manifest\nJSON\n(backends, config)", 
                      fillcolor="#003366", color="#4488ff", fontcolor="#ffffff"];
        OUT_CERT [label="/gc/certificate\nJSON\n(CertBundle)", 
                  fillcolor="#003366", color="#4488ff", fontcolor="#ffffff"];

        { rank=same; OUT_STATE; OUT_TRAJ; OUT_STATUS; OUT_MANIFEST; OUT_CERT; }
        OUT_STATE -> OUT_TRAJ -> OUT_STATUS -> OUT_MANIFEST -> OUT_CERT [style="invis"];

        // File outputs
        OUT_TUM [label="Trajectory.txt\nTUM Format\n(For evaluation)", 
                 fillcolor="#003366", color="#4488ff", fontcolor="#ffffff"];
        OUT_NPZ [label="Diagnostics.npz\nPer-Scan Metrics", 
                 fillcolor="#003366", color="#4488ff", fontcolor="#ffffff"];
        OUT_TF [label="TF Broadcast\nodom_frame â†’ base_link", 
                fillcolor="#006633", color="#44ff88", fontcolor="#ffffff"];

        { rank=same; OUT_TUM; OUT_NPZ; OUT_TF; }
        OUT_TUM -> OUT_NPZ -> OUT_TF [style="invis"];
    }

    // ============================================================================
    // LAYER 8: AUDIT
    // ============================================================================
    subgraph cluster_audit {
        label="ðŸ“Š Audit";
        style="filled,rounded";
        fillcolor="#1a0a2a";
        color="#aa00aa";
        fontcolor="#cccccc";
        fontsize=11;

        WIRING [label="wiring_auditor\nEnd-of-Run Summary\n(JSON)", 
                fillcolor="#2d004d", color="#aa00aa", fontcolor="#ffffff"];
    }

    // ============================================================================
    // LEGEND
    // ============================================================================
    subgraph cluster_legend {
        label="Legend";
        style="filled,rounded";
        fillcolor="#111111";
        color="#333333";
        fontcolor="#888888";
        fontsize=10;

        L1 [label="Active/Processing", fillcolor="#0f3d0f", color="#00ff00", fontcolor="#ffffff", width=1.0];
        L2 [label="Unused/Dead-end", fillcolor="#2a0e0e", style="filled,rounded,dashed", color="#ff4444", fontcolor="#ffcccc", width=1.0];
        L3 [label="Closed-form (Exact)", fillcolor="#2a4a2a", color="#00ff00", fontcolor="#ffffff", width=1.0];
        L4 [label="Approximate (Frobenius)", fillcolor="#4a3a1a", color="#ff8800", fontcolor="#ffffff", width=1.0];
        L5 [label="Evidence", fillcolor="#2a4a6a", color="#00ccff", fontcolor="#ffffff", width=1.0];
        L6 [label="State Storage", fillcolor="#1e1e2e", color="#6666aa", fontcolor="#ffffff", width=1.0];
        L7 [label="Output", fillcolor="#003366", color="#4488ff", fontcolor="#ffffff", width=1.0];
        L8 [label="Hypothesis Merge", fillcolor="#4a2a2a", color="#ff6666", fontcolor="#ffffff", width=1.0];

        L1 -> L2 -> L3 -> L4 -> L5 -> L6 -> L7 -> L8 [style="invis"];
    }

    // ============================================================================
    // CONNECTIONS - DATA FLOW
    // ============================================================================

    // Rosbag -> Sensor Hub (Active flows)
    BAG_ODOM -> ODOM_NORM [color="#00ff00", penwidth=3];
    BAG_MID_LIDAR -> LIVOX_CONV [color="#00ff00", penwidth=3];
    BAG_MID_IMU -> IMU_NORM [color="#00ff00", penwidth=3];

    // Dead-end flows
    BAG_VRPN -> DEAD_AUDIT [style="dashed", color="#ff4444", penwidth=1.5];
    BAG_CAM_IMU -> DEAD_AUDIT [style="dashed", color="#ff4444", penwidth=1.5];
    BAG_CAM_COLOR -> DEAD_AUDIT [style="dashed", color="#ff4444", penwidth=1.5];
    BAG_CAM_DEPTH -> DEAD_AUDIT [style="dashed", color="#ff4444", penwidth=1.5];
    BAG_AVIA_LIDAR -> DEAD_AUDIT [style="dashed", color="#ff4444", penwidth=1.5];
    BAG_AVIA_IMU -> DEAD_AUDIT [style="dashed", color="#ff4444", penwidth=1.5];

    // Sensor Hub -> Canonical
    ODOM_NORM -> CAN_ODOM [color="#00ff00", penwidth=3];
    LIVOX_CONV -> CAN_LIDAR [color="#00ff00", penwidth=3];
    IMU_NORM -> CAN_IMU [color="#00ff00", penwidth=3];
    DEAD_AUDIT -> CAN_DEAD [color="#aa00aa", penwidth=2];

    // Canonical -> Backend
    CAN_ODOM -> S09A [color="#00ff00", penwidth=2, label="Odom pose/cov"];
    CAN_LIDAR -> S01 [color="#00ff00", penwidth=3, label="PointCloud2"];
    CAN_IMU -> IMU_BUF [color="#00ff00", penwidth=3];
    
    // IMU Buffer -> Pipeline (two paths)
    IMU_BUF -> S03 [color="#66aa66", penwidth=2, style="dashed", label="Preintegration"];
    IMU_BUF -> S09B [color="#66aa66", penwidth=2, style="dashed", label="Gravity"];
    IMU_BUF -> S09C [color="#66aa66", penwidth=2, style="dashed", label="Gyro"];

    // State feedback loops (critical!)
    ST_BELIEF -> S02 [color="#6666aa", penwidth=2, style="dashed", label="belief_prev"];
    ST_MAP -> S05 [color="#6666aa", penwidth=2, style="dashed", label="map_stats"];
    ST_PROC -> S02 [color="#6666aa", penwidth=2, style="dashed", label="Q (process noise)"];
    ST_MEAS -> S09B [color="#6666aa", penwidth=1.5, style="dashed", label="Î£a"];
    ST_MEAS -> S09C [color="#6666aa", penwidth=1.5, style="dashed", label="Î£g"];
    ST_BUCKET -> S05 [color="#6666aa", penwidth=2, style="dashed", label="Î» (reliability)"];

    // IW noise updates (self-adaptive)
    S08 -> ST_BUCKET [color="#ffaa00", penwidth=1.5, style="dotted", label="Translation residuals"];
    S09B -> ST_MEAS [color="#ffaa00", penwidth=1.5, style="dotted", label="Accel IW update"];
    S09C -> ST_MEAS [color="#ffaa00", penwidth=1.5, style="dotted", label="Gyro IW update"];
    S12 -> ST_PROC [color="#ffaa00", penwidth=1.5, style="dotted", label="Innovation residuals"];

    // Pipeline -> Hypothesis merge
    S14 -> S15 [color="#ff6666", penwidth=3, label="8Ã— parallel"];

    // Hypothesis merge -> State update
    S15 -> ST_BELIEF [color="#ff6666", penwidth=3];
    S15 -> ST_MAP [color="#ff6666", penwidth=2, label="Map update"];

    // State -> Outputs
    ST_BELIEF -> OUT_STATE [color="#4488ff", penwidth=3];
    ST_BELIEF -> OUT_TRAJ [color="#4488ff", penwidth=3];
    ST_BELIEF -> OUT_STATUS [color="#4488ff", penwidth=2];
    ST_BELIEF -> OUT_MANIFEST [color="#4488ff", penwidth=2];
    ST_BELIEF -> OUT_CERT [color="#4488ff", penwidth=2];
    ST_BELIEF -> OUT_TUM [color="#4488ff", penwidth=2];
    ST_BELIEF -> OUT_NPZ [color="#4488ff", penwidth=2];
    ST_BELIEF -> OUT_TF [color="#44ff88", penwidth=2];

    // Audit connections
    CAN_DEAD -> WIRING [color="#aa00aa", penwidth=2];
    OUT_STATUS -> WIRING [color="#aa00aa", penwidth=2];
    OUT_MANIFEST -> WIRING [color="#aa00aa", penwidth=2];

    // Layout constraints
    { rank=sink; L8; WIRING; OUT_TUM; }
}
