# =============================================================================
# GC UNIFIED CONFIG - Golden Child SLAM v2 Configuration
# =============================================================================
#
# This file consolidates all configuration for the GC SLAM system.
# Both gc_sensor_hub and gc_backend_node load parameters from this file.
#
# Topic Naming Convention:
#   Raw (from bag)              Canonical (for backend)
#   ─────────────────────────   ────────────────────────────
#   /livox/mid360/lidar     →   /gc/sensors/lidar_points
#   /odom                   →   /gc/sensors/odom
#   /livox/mid360/imu       →   /gc/sensors/imu
#
# Reference: docs/GOLDEN_CHILD_INTERFACE_SPEC.md
# =============================================================================

# -----------------------------------------------------------------------------
# Sensor Hub Configuration (Process 1)
# -----------------------------------------------------------------------------
gc_sensor_hub:
  ros__parameters:
    # Livox Converter: CustomMsg -> PointCloud2
    livox_converter:
      input_topic: /livox/mid360/lidar
      output_topic: /gc/sensors/lidar_points
      input_msg_type: livox_ros_driver2/msg/CustomMsg
      frame_id: ""  # Empty preserves bag frame

    # Odom Normalizer: raw odom -> canonical odom
    odom_normalizer:
      input_topic: /odom
      output_topic: /gc/sensors/odom
      output_frame: ""  # Preserve bag frame_id (no-TF mode).
      child_frame: ""   # Preserve bag child_frame_id (no-TF mode).

    # IMU Normalizer: raw IMU -> canonical IMU
    imu_normalizer:
      input_topic: /livox/mid360/imu
      output_topic: /gc/sensors/imu
      output_frame: ""  # Preserve bag frame_id (no-TF mode).

    # Dead End Audit: subscribes to unused topics for accountability
    dead_end_audit:
      topic_specs:
        - "/camera/imu|sensor_msgs/msg/Imu"
        - "/camera/color/image_raw/compressed|sensor_msgs/msg/CompressedImage"
        - "/camera/aligned_depth_to_color/image_raw/compressedDepth|sensor_msgs/msg/CompressedImage"
        - "/vrpn_client_node/UGV/pose|geometry_msgs/msg/PoseStamped"
        - "/livox/avia/imu|sensor_msgs/msg/Imu"
        - "/livox/avia/lidar|livox_ros_driver/msg/CustomMsg"
      required_topics: []  # None required by default
      required_timeout_sec: 10.0
      status_publish_period_sec: 5.0
      qos_reliability: best_effort
      qos_depth: 10

# -----------------------------------------------------------------------------
# Backend Configuration (Process 2)
# -----------------------------------------------------------------------------
gc_backend:
  ros__parameters:
    # Sensor subscriptions - ONLY /gc/sensors/* (canonical topics)
    lidar_topic: /gc/sensors/lidar_points
    odom_topic: /gc/sensors/odom
    imu_topic: /gc/sensors/imu

    # Frame IDs
    odom_frame: odom
    # For M3DGR Dynamic01, bag truth uses base_footprint. Keep this consistent with odom child_frame_id.
    base_frame: base_footprint

    # No-TF extrinsics (T_{base<-sensor}) in [x, y, z, rx, ry, rz] (rotvec, radians).
    # LiDAR: Z-up confirmed (diagnose_coordinate_frames.py) - rotation [0,0,0] is correct.
    # IMU: 154.5° rotation from gravity alignment tool. UNDER INVESTIGATION - there may be
    #      sign convention issues elsewhere in the pipeline that need to be resolved first.
    # See: tools/estimate_imu_base_extrinsic_rotation.py
    T_base_lidar: [-0.011, 0.0, 0.778, 0.0, 0.0, 0.0]
    # IMU extrinsic: 28° rotation to align IMU gravity with base +Z
    # (Previous 154.5° rotation was inverting both gravity and yaw axis)
    # Restored to match good run (2026-01-26 22:06:57) values
    T_base_imu:   [0.0,   0.0, 0.0,   -0.015586, 0.489293, 0.0]

    # Trajectory export
    trajectory_export_path: /tmp/gc_slam_trajectory.tum

    # Status publishing
    status_check_period_sec: 5.0

    # Map forgetting
    forgetting_factor: 0.99

    # Smoothed initial anchor (PIPELINE_DESIGN_GAPS §5.4.1): buffer first K odom, then A_smoothed = weighted t̄ + polar(R); export = anchor_correction ∘ pose_belief
    init_window_odom_count: 10
