# =============================================================================
# GC UNIFIED CONFIG - Geometric Compositional SLAM v2
# =============================================================================
#
# SINGLE SOURCE OF TRUTH for all configuration.
# Extrinsics from: Kimera_Data/calibration/robots/acl_jackal2/extrinsics.yaml
#
# Topic flow: raw bag → pointcloud_passthrough / odom_normalizer / imu_normalizer
#             → /gc/sensors/* → gc_backend_node
#
# Reference: docs/GC_SLAM.md
# =============================================================================

# -----------------------------------------------------------------------------
# Sensor Hub Configuration
# -----------------------------------------------------------------------------
gc_sensor_hub:
  ros__parameters:
    pointcloud_passthrough:
      input_topic: /acl_jackal/lidar_points
      output_topic: /gc/sensors/lidar_points
      qos_depth: 10

    odom_normalizer:
      input_topic: /acl_jackal/jackal_velocity_controller/odom
      output_topic: /gc/sensors/odom
      output_frame: ""
      child_frame: ""

    imu_normalizer:
      input_topic: /acl_jackal/forward/imu
      output_topic: /gc/sensors/imu
      output_frame: ""

    # Dead-end audit: topics in bag not consumed by GC (accountability)
    dead_end_audit:
      topic_specs:
        - "/acl_jackal/forward/infra1/image_rect_raw/compressed|sensor_msgs/msg/CompressedImage"
        - "/acl_jackal/forward/infra2/image_rect_raw/compressed|sensor_msgs/msg/CompressedImage"
      required_topics: []
      required_timeout_sec: 10.0
      status_publish_period_sec: 5.0
      qos_reliability: best_effort
      qos_depth: 10

# -----------------------------------------------------------------------------
# Backend Configuration
# -----------------------------------------------------------------------------
gc_backend:
  ros__parameters:
    lidar_topic: /gc/sensors/lidar_points
    odom_topic: /gc/sensors/odom
    imu_topic: /gc/sensors/imu

    odom_frame: "acl_jackal2/odom"
    base_frame: "acl_jackal2/base"

    pointcloud_layout: vlp16
    lidar_sigma_meas: 1e-3

    # Extrinsics: from Kimera_Data/calibration/robots/acl_jackal2/extrinsics.yaml
    # Format: [x, y, z, rx, ry, rz] where rotation is in radians (rotvec).
    # This is the SINGLE SOURCE OF TRUTH - no overrides in launch file or run script.
    #
    # IMU NOTE: The bag publishes IMU in forward_imu_optical_frame.
    # D435i accelerometer reads -Y when stationary (gravity in +Y in optical frame).
    # Base frame is Z-up: stationary accel should be [0, 0, +g] to cancel gravity_W [0, 0, -g].
    # Rotation Rx(-90°) maps IMU -Y to base +Z: rotvec = [-pi/2, 0, 0] = [-1.570796, 0, 0]
    extrinsics_source: inline
    T_base_lidar: [-0.065447, -0.100474, 0.108987, -0.002723, -0.069383, 0.028979]
    T_base_imu:   [-0.016020, -0.030220, 0.007400, -1.570796, 0.0, 0.0]

    trajectory_export_path: /tmp/gc_slam_trajectory.tum
    status_check_period_sec: 5.0
    init_window_odom_count: 10
    enable_timing: false

    map_backend: primitive_map
    pose_evidence_backend: primitives

    # Numerical epsilons (domain stabilization)
    eps_psd: 1e-12
    eps_lift: 1e-9
    eps_mass: 1e-12

    # Fusion conditioning
    alpha_min: 1.0
    alpha_max: 1.0
    kappa_scale: 1.0
    c0_cond: 1e6

    # Power tempering
    power_beta_min: 0.25
    power_beta_exc_c: 50.0
    power_beta_z_c: 1.0

    # Excitation coupling
    c_dt: 1.0
    c_ex: 1.0
    c_frob: 1.0

    # Planar prior (soft constraints)
    planar_z_ref: 0.0
    planar_z_sigma: 0.1
    planar_vz_sigma: 0.01
    enable_planar_prior: true

    # Odom twist evidence
    enable_odom_twist: true
    odom_twist_vel_sigma: 0.1
    odom_twist_wz_sigma: 0.01
    odom_z_variance_prior: 1000000.0

    # OT association params
    ot_epsilon: 0.1
    ot_tau_a: 0.5
    ot_tau_b: 0.5

    # Reduced from 512/1024/8 to avoid OOM in primitive_map_fuse (flat_size = (n_feat+n_surfel)*k_assoc)
    n_feat: 256
    n_surfel: 512
    k_assoc: 8
    k_sinkhorn: 50
    k_insert_tile: 64
    primitive_map_max_size: 50000
    primitive_forgetting_factor: 0.999
    primitive_merge_threshold: 0.1
    primitive_cull_weight_threshold: 1e-4

    # Surfel extraction
    surfel_voxel_size_m: 0.1
    surfel_min_points_per_voxel: 3

    # Diagnostics
    save_full_diagnostics: false

    camera_rgbd_topic: /gc/sensors/camera_rgbd
    camera_K: [500.0, 500.0, 320.0, 240.0]
    T_base_camera: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    ringbuf_len: 5
    bev_backend_enabled: false
    bev_views_n: 0
